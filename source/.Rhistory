)
print(fit_2, probs=c(0.025, 0.975))
posterior_2 = As.mcmc.list(fit_2)
plot(posterior_2[, c("b[1]", "b[2]", "b[3]", "sigma")])
plot(posterior_2[, c("b[3]")])
fit_few_samples  = sampling(stan_model,
data=data,
chains=3,
iter=1100,
warmup=1000
)
fit_many_samples  = sampling(stan_model,
data=data,
chains=3,
iter=11000,
warmup=1000
)
print(fit_few_samples)
print(fit)
print(fit_many_samples)
plot(As.mcmc.list(fit_few_samples))
plot(As.mcmc.list(fit_few_samples)[1:3])
plot(As.mcmc.list(fit_few_samples)[1:3])
plot(As.mcmc.list(fit_few_samples)[,1:3])
plot(As.mcmc.list(fit_few_samples)[,1:3])
plot(As.mcmc.list(fit_many_samples)[,1:3])
plot(fit_few_samples)
plot(fit_many_samples)
set.seed(123) # initiate random number generator for reproducability
n.few = 20
x.few = runif(n=n.few, min=0, max=1)
y.few = rnorm(n=n.few, mean=a+b*x.few, sd=sigma)
n.many = 500
x.many = runif(n=n.many, min=0, max=1)
y.many = rnorm(n=n.many, mean=a+b*x.many, sd=sigma)
par(mfrow=c(1,3))
plot(x.few,y.few)
plot(x,y)
plot(x.many,y.many)
data.few = list(n=n.few,
x=x.few,
y=y.few)
data.many = list(n=n.many,
x=x.many,
y=y.many)
fit_few_obs  = sampling(stan_model,
data=data.few,
chains=3,
iter=2000,
warmup=1000
)
fit_many_obs  = sampling(stan_model,
data=data.many,
chains=3,
iter=2000,
warmup=1000
)
print(fit_few_obs)
print(fit_few_obs)
print(fit)
print(fit_many_obs)
plot(fit_few_obs)
plot(fit_few_obs)
plot(fit_few_obs)
plot(fit_many_obs)
posterior=as.matrix(fit)
posterior_few_obs=as.matrix(fit_few_obs)
posterior_many_obs=as.matrix(fit_many_obs)
density_1=density(posterior[, "b[2]"])
density_few_obs=density(posterior_few_obs[, "b[2]"])
density_many_obs=density(posterior_many_obs[, "b[2]"])
par(mfrow=c(1,1))
plot(density_1, xlim=c(0.5,2.5), ylim=c(0,4), main="slope b[2]")
lines(density_few_obs, col="red")
lines(density_many_obs, col="blue")
legend("topleft", bty="n", legend=c("few obs","med obs","many obs"),
lty=c(1,1,1), col=c("red","black","blue"))
rm(list=ls())
library(rstan)
library(coda)
rstan_options(auto_write = TRUE)
options(mc.cores = 3)
rm(list=ls())
library(rstan)
library(coda)
rstan_options(auto_write = TRUE)
options(mc.cores = 3)
stan_code_1 = '
data {
int n;
vector[n] x;
vector[n] y;
}
parameters {
vector[2] b;
real<lower=0> sigma;  // standard deviation
}
model {
// priors
b[1] ~ normal(0, 10);
// b[2] ~ normal(0, 10);
sigma ~ normal(0, 10);
// likelihood
y ~ normal(b[1]+b[2]*x, sigma);
}
'
stan_code_2 = '
data {
int n;
vector[n] x;
vector[n] y;
}
parameters {
vector[2] b;
real<lower=0> sigma;  // standard deviation
}
model {
// priors
b[1] ~ normal(0, 10);
b[2] ~ normal(0, 10);
sigma ~ normal(0, 10);
// likelihood
y ~ normal(b[1]+b[2]*x, sigma);
}
'
stan_code_3 = '
data {
int n;
vector[n] x;
vector[n] y;
}
parameters {
vector[2] b;
real<lower=0> sigma;  // standard deviation
}
model {
// priors
b[1] ~ normal(0, 10);
b[2] ~ normal(0, 1);
sigma ~ normal(0, 10);
// likelihood
y ~ normal(b[1]+b[2]*x, sigma);
}
'
stan_code_4 = '
data {
int n;
vector[n] x;
vector[n] y;
}
parameters {
vector[2] b;
real<lower=0> sigma;  // standard deviation
}
model {
// priors
b[1] ~ normal(0, 10);
b[2] ~ normal(0, 0.1);
sigma ~ normal(0, 10);
// likelihood
y ~ normal(b[1]+b[2]*x, sigma);
}
'
stan_model_1 = stan_model(model_code=stan_code_1)
stan_model_2 = stan_model(model_code=stan_code_2)
stan_model_3 = stan_model(model_code=stan_code_3)
stan_model_4 = stan_model(model_code=stan_code_4)
#------------------------------------------------------------------------------
set.seed(123) # initiate random number generator for reproducability
n=100
a=1
b=2
sigma=0.5
x = runif(n=n, min=0, max=1)
y = rnorm(n=n, mean=a+b*x, sd=sigma)
df = data.frame(x=x,
y=y)
plot(df)
data = list(n=n,
x=df$x,
y=df$y)
fit_1  = sampling(stan_model_1,
data=data,
chains=3,
iter=2000,
warmup=1000
)
fit_2  = sampling(stan_model_2,
data=data,
chains=3,
iter=2000,
warmup=1000
)
fit_3  = sampling(stan_model_3,
data=data,
chains=3,
iter=2000,
warmup=1000
)
fit_4  = sampling(stan_model_4,
data=data,
chains=3,
iter=2000,
warmup=1000
)
posterior_1 = as.matrix(fit_1)
posterior_2 = as.matrix(fit_2)
posterior_3 = as.matrix(fit_3)
posterior_4 = as.matrix(fit_4)
density_1=density(posterior_1[, "b[2]"])
density_2=density(posterior_2[, "b[2]"])
density_3=density(posterior_3[, "b[2]"])
density_4=density(posterior_4[, "b[2]"])
par(mfrow=c(1,1))
plot(density_1, xlim=c(0,4), ylim=c(0,3), main="slope for n_obs=100")
lines(density_2, col="red")
lines(density_3, col="blue")
lines(density_4, col="green")
legend("topright", legend=c("flat","N(0,10)","N(0,1)","N(0,0.1)"), bty="n", lwd=rep(2,4), col=c("black","red","blue","green"))
set.seed(123) # initiate random number generator for reproducability
n=1000
a=1
b=2
sigma=0.5
x = runif(n=n, min=0, max=1)
y = rnorm(n=n, mean=a+b*x, sd=sigma)
df = data.frame(x=x,
y=y)
plot(df)
data = list(n=n,
x=df$x,
y=df$y)
fit_1  = sampling(stan_model_1,
data=data,
chains=3,
iter=2000,
warmup=1000
)
fit_2  = sampling(stan_model_2,
data=data,
chains=3,
iter=2000,
warmup=1000
)
fit_3  = sampling(stan_model_3,
data=data,
chains=3,
iter=2000,
warmup=1000
)
fit_4  = sampling(stan_model_4,
data=data,
chains=3,
iter=2000,
warmup=1000
)
posterior_1 = as.matrix(fit_1)
posterior_2 = as.matrix(fit_2)
posterior_3 = as.matrix(fit_3)
posterior_4 = as.matrix(fit_4)
density_1=density(posterior_1[, "b[2]"])
density_2=density(posterior_2[, "b[2]"])
density_3=density(posterior_3[, "b[2]"])
density_4=density(posterior_4[, "b[2]"])
par(mfrow=c(1,1))
plot(density_1, xlim=c(0,4), ylim=c(0,8), main="slope for n_obs=1000")
lines(density_2, col="red")
lines(density_3, col="blue")
lines(density_4, col="green")
legend("topright", legend=c("flat","N(0,10)","N(0,1)","N(0,0.1)"), bty="n", lwd=rep(2,4), col=c("black","red","blue","green"))
plot(density_1, xlim=c(0,4), ylim=c(0,8), main="slope for n_obs=1000")
lines(density_2, col="red")
lines(density_3, col="blue")
lines(density_4, col="green")
legend("topright", legend=c("flat","N(0,10)","N(0,1)","N(0,0.1)"), bty="n", lwd=rep(2,4), col=c("black","red","blue","green"))
set.seed(123) # initiate random number generator for reproducability
n=10
a=1
b=2
sigma=0.5
x = runif(n=n, min=0, max=1)
y = rnorm(n=n, mean=a+b*x, sd=sigma)
df = data.frame(x=x,
y=y)
plot(df)
data = list(n=n,
x=df$x,
y=df$y)
fit_1  = sampling(stan_model_1,
data=data,
chains=3,
iter=2000,
warmup=1000
)
fit_2  = sampling(stan_model_2,
data=data,
chains=3,
iter=2000,
warmup=1000
)
fit_3  = sampling(stan_model_3,
data=data,
chains=3,
iter=2000,
warmup=1000
)
fit_4  = sampling(stan_model_4,
data=data,
chains=3,
iter=2000,
warmup=1000
)
posterior_1 = as.matrix(fit_1)
posterior_2 = as.matrix(fit_2)
posterior_3 = as.matrix(fit_3)
posterior_4 = as.matrix(fit_4)
density_1=density(posterior_1[, "b[2]"])
density_2=density(posterior_2[, "b[2]"])
density_3=density(posterior_3[, "b[2]"])
density_4=density(posterior_4[, "b[2]"])
par(mfrow=c(1,1))
plot(density_1, xlim=c(0,4), ylim=c(0,3), main="slope for n_obs=10")
lines(density_2, col="red")
lines(density_3, col="blue")
lines(density_4, col="green")
legend("topright", legend=c("flat","N(0,10)","N(0,1)","N(0,0.1)"), bty="n", lwd=rep(2,4), col=c("black","red","blue","green"))
rm(list=ls())
library(rstan)
library(coda)
library(BayesianTools)
rstan_options(auto_write = TRUE)
options(mc.cores = 3) # number of CPU cores
set.seed(123) # initiate random number generator for reproducability
n=50
a=1.0
b=0.5
c=0.4
sigma=0.15
x = runif(n=n, min=0, max=1)
y = rnorm(n=n, mean=a+b*x+c*x^2, sd=sigma)
y = rnorm(n=n, mean=a+b*x+c*x^2, sd=sigma)
df = data.frame(x=x,
y=y)
plot(df)
#------------------------------------------------------------------------------
# define stan model
#------------------------------------------------------------------------------
stan_code = '
data {
int n;
vector[n] x;
vector[n] y;
}
parameters {
real a;
real b;
real<lower=0> sigma;  // standard deviation
}
model {
// priors
a ~ normal(0, 10);
b ~ normal(0, 10);
sigma ~ normal(0, 10);
// likelihood
y ~ normal(a+b*x, sigma);
}
'
#------------------------------------------------------------------------------
# prepare data and compile model
#------------------------------------------------------------------------------
data = list(n=n,
x=df$x,
y=df$y)
stan_model = stan_model(model_code=stan_code)
#------------------------------------------------------------------------------
# MCMC sampling
#------------------------------------------------------------------------------
fit  = sampling(stan_model,
data=data,
chains=3,
iter=2000,
warmup=1000
)
#------------------------------------------------------------------------------
# MCMC sampling
#------------------------------------------------------------------------------
fit  = sampling(stan_model,
data=data,
chains=3,
iter=2000,
warmup=1000
)
print(fit, digits=3, probs=c(0.025, 0.975))
plot(fit)
plot(As.mcmc.list(fit)) # from coda package
fit
View(fit)
posterior=as.matrix(fit)
str(posterior)
head(posterior)
posterior[, 1]
str(posterior[, 1])
head(posterior[, 1])
hist(posterior[, 1])
hist(posterior[, 1])
hist(posterior[, "a"])
str(posterior[1, ])
posterior[1, ]
pairs(fit, pars=c("a","b","sigma"))
correlationPlot(posterior[, 1:3], thin=1) # from BayesianTools package
hist(posterior[, "b"], xlim=c(0,max(posterior[, "b"])))
abline(v=0, col="red", lwd=2)
sum(posterior[, "b"]>0)/nrow(posterior)
(posterior[, "b"]>0.9)
sum( (posterior[, "b"]>0.9) & (posterior[, "b"]<1.1) )/nrow(posterior)
sum( (posterior[, "b"]>0.9) & (posterior[, "b"]<1.1) )
sum( (posterior[, "b"]>0.9) & (posterior[, "b"]<1.1) )/nrow(posterior)
df = data.frame(x=x,
y=y)
plot(df)
plot(df)
posterior[1,"a"]
posterior[1,"b"]
abline(posterior[1,"a"], posterior[1,"b"], col=adjustcolor("red", alpha.f=0.3))
plot(df)
for(i in 1:100){
abline(posterior[i,"a"], posterior[i,"b"], col=adjustcolor("red", alpha.f=0.3))
}
x.pred = seq(from=0, to=1, by=0.1)
x.pred
x.pred = seq(from=0, to=1, by=0.1)
y.cred = matrix(0, nrow=nrow(posterior), ncol=length(x.pred))
head(y.cred)
for(i in 1:nrow(posterior)){
y.cred[i, ] = posterior[i,"a"] + posterior[i,"b"]*x.pred
}
head(y.cred)
head(y.cred)
plot(df)
for(i in 1:100){
lines(x.pred, y.cred[i, ], col=adjustcolor("red", alpha.f=0.3))
}
y.cred[,1]
hist(y.cred[,1])
y.cred.mean = apply(y.cred, 2, function(x) mean(x))
plot(df)
y.cred.mean
lines(x.pred, y.cred.mean, col="red", lwd=2)
y.cred.q05 = apply(y.cred, 2, function(x) quantile(x, probs=0.05))
lines(x.pred, y.cred.q05, col="red", lwd=2, lty=2)
y.cred.q95 = apply(y.cred, 2, function(x) quantile(x, probs=0.95))
lines(x.pred, y.cred.q95, col="red", lwd=2, lty=2)
y.pred = matrix(0, nrow=nrow(posterior), ncol=length(x.pred))
y.pred = matrix(0, nrow=nrow(posterior), ncol=length(x.pred))
length(x.pred)
y.cred[i, ]
rep(posterior[i, "sigma"],length(x.pred))
for(i in 1:nrow(posterior)){
y.pred[i, ] = rnorm(n=length(x.pred), mean=y.cred[i, ], sd=rep(posterior[i, "sigma"],length(x.pred)) )
}
plot(df)
lines(x.pred, y.cred.mean, col="red", lwd=2)
lines(x.pred, y.cred.q05, col="red", lwd=2, lty=2)
lines(x.pred, y.cred.q95, col="red", lwd=2, lty=2)
y.pred.mean = apply(y.pred, 2, function(x) mean(x))
lines(x.pred, y.pred.mean, col="blue", lwd=2)
y.pred.q05 = apply(y.pred, 2, function(x) quantile(x, probs=0.05))
lines(x.pred, y.pred.q05, col="blue", lwd=2, lty=2)
y.pred.q95 = apply(y.pred, 2, function(x) quantile(x, probs=0.95))
lines(x.pred, y.pred.q95, col="blue", lwd=2, lty=2)
legend("topleft", legend=c("90% credible","90% prediction"), lwd=c(2,2), col=c("red","blue"), bty="n", lty=c(2,2))
y.cred[, 1]
y.cred[, 1]
y.pred[, 1]
hist(y.pred[, 1])
x.pred = df$x
x.pred = df$x
y.cred = matrix(0, nrow=nrow(posterior), ncol=length(x.pred))
for(i in 1:nrow(posterior)){
y.cred[i, ] = posterior[i,"a"] + posterior[i,"b"]*x.pred
}
y.cred.mean = apply(y.cred, 2, function(x) mean(x))
y.cred.q05 = apply(y.cred, 2, function(x) quantile(x, probs=0.05))
y.cred.q95 = apply(y.cred, 2, function(x) quantile(x, probs=0.95))
y.pred = matrix(0, nrow=nrow(posterior), ncol=length(x.pred))
for(i in 1:nrow(posterior)){
y.pred[i, ] = rnorm(n=length(x.pred), mean=y.cred[i, ], sd=rep(posterior[i, "sigma"],length(x.pred)) )
}
y.pred.mean = apply(y.pred, 2, function(x) mean(x))
y.pred.q05 = apply(y.pred, 2, function(x) quantile(x, probs=0.05))
y.pred.q95 = apply(y.pred, 2, function(x) quantile(x, probs=0.95))
plot(df$y, y.pred.mean, ylim=c(min(df$y), max(df$y)), xlab="observed", ylab="predicted")
abline(0,1)
abline(0,1)
for (i in 1:n){
lines(c(df$y[i], df$y[i]), c(y.pred.q05[i], y.pred.q95[i]))
}
plot(df$y, df$y-y.pred.mean)
abline(0,0)
print(fit)
print(fit)
summary.fit = summary(fit)$summary
summary.fit
summary.fit
plot(df)
abline(summary.fit["a","mean"], summary.fit["b","mean"], col="red", lwd=2)
points(x.pred,y.cred.mean, col="red", pch="+")
plot(df)
abline(summary.fit["a","mean"], summary.fit["b","mean"], col="red", lwd=2)
points(x.pred,y.cred.mean, col="red", pch="+")
legend("topleft", legend=c("prediction using mean parameters (WRONG!)","means of predictions"), bty="n",
lty=c(1,NA), pch=c(NA,"+"), col=c("red","red"), lwd=c(2,2))
